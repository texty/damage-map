<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <script src="https://unpkg.com/h3-js@3.7.2"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
    <script src="https://unpkg.com/deck.gl@^8.1.0/dist.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.4.0/d3.min.js" integrity="sha512-uEB5VA2mmiakiYbFIvXE2n5h0BBWxAHp1UPEK2eHSpHbxJkzxbQ9HmmLBqS+Iwhwh35r2CC34HMdWmqHoibTuA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<style>
     body {
    margin: 0;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
  }
  
  .deck-tooltip {
    font-size: 0.8em;
    font-family: Helvetica, Arial, sans-serif;
  }

  #container {
    width: 100vw; height: 100vh;
  }

</style>
<body>

    <button id="to3D">to 3D</button>
    <button id="to2D" >to 2D</button>
    <div id="container"></div>

    <script>

        const {DeckGL, H3HexagonLayer, FlyToInterpolator} = deck;

        function getRGB(str){
            var match = str.match(/rgba?\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3})\)?(?:, ?(\d(?:\.\d?))\))?/);
            return match ? [ +match[1], +match[2], +match[3]]
            : {};
            }

        var color = d3.scaleLinear()
            .domain([0, 1, 5, 10, 15, 30])
            .range(["#ffffb2", "#fed976", "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c", "#b10026"]);

        var color2 = d3.scaleLinear()
            .domain([0, 5, 15, 20, 25, 80])
            .range(["#ffffb2", "#fed976", "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c", "#b10026"]);


        const layer1 = new H3HexagonLayer({
            id: 'H3HexagonLayer',
            data: 'https://raw.githubusercontent.com/samoylich/damage_map_data/main/mariupol.json',
            elevationScale: 20,
            extruded: true,
            filled: true,
            getElevation: d => d.count,
            getFillColor: d => getRGB(color(d.count)),
            getHexagon: d => d.hex,
            wireframe: false,
            pickable: true,
            visible: true,
            opacity: 0.7,
        });

        const layer2 = new H3HexagonLayer({
            id: 'H3HexagonLayer',
            data: 'https://raw.githubusercontent.com/samoylich/damage_map_data/main/mariupol(10).json',
            elevationScale: 20,
            extruded: true,
            filled: true,
            getElevation: d => d.count * 2,
            getFillColor: d => getRGB(color2(d.count)),
            getHexagon: d => d.hex,
            wireframe: false,
            pickable: true,
            visible: true
        });

      
        const mydeck = new DeckGL({
            container: 'container',
        mapStyle: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
        initialViewState: {
            longitude: 37.5,
            latitude: 47,
            zoom: 10,
            maxZoom: 20,
            pitch: 0,
            bearing: 0
        },
        onViewStateChange: ({viewState}) => {
            if(viewState.zoom > 11){
                mydeck.setProps({layers: [layer2]})
                return {...viewState, pitch: 60}
               
            } else {
                mydeck.setProps({layers: [layer1]})
                return  {...viewState, pitch: 0}

            }
                
        },
        
        controller: true,
        getTooltip: ({object}) => object && `пошкоджено: ${Math.round(object.count)} %`,
        layers: [layer1]
    });

            </script>
            
        </body>
 </html>
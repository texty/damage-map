<html>

<head>
    <title>Road AccidentsIncidents</title>
        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
        <script src="https://unpkg.com/h3-js@^3.0.0"></script>
        <script src="https://unpkg.com/deck.gl@^8.0.0/dist.min.js"></script>
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.13.0/mapbox-gl.js"></script>

    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.13.0/mapbox-gl.css" rel="stylesheet" />
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <style type="text/css">
        #map { position:absolute; top:0; bottom:0; width:100%; }
        body {
            font-family: Helvetica, Arial, sans-serif;
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 0
        }

        #control-panel {
            position: absolute;
            background: #fff;
            top: 0;
            left: 0;
            margin: 12px;
            padding: 20px;
            font-size: 12px;
            line-height: 1.5;
            z-index: 1;
        }

        label {
            display: inline-block;
            width: 140px;
        }
        </style>
</head>

<body>
<div id="map"></div>
</body>
<script type="text/javascript">

const powScale = d3.scalePow()
            .exponent(2)
            .domain([0, 1])
            .range([0, 1]);

 function getRGB(str){
            var match = str.match(/rgba?\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3})\)?(?:, ?(\d(?:\.\d?))\))?/);
            return match ? [ +match[1], +match[2], +match[3]]
            : {};
            }

        var color = d3.scaleLinear()
            .domain([10, 20, 30, 35, 45])
            .range(["#eee1e1", "#f0b8b9", "#e67c7d", "#c44b4d", "#ac2123"]);

        var color2 = d3.scaleLinear()
            .domain([10, 20, 30, 35, 45])
            .range(["#eee1e1", "#f0b8b9", "#e67c7d", "#c44b4d", "#ac2123"]);


mapboxgl.accessToken = 'pk.eyJ1IjoiZXZnZXNoYWRyb3pkb3ZhIiwiYSI6ImNqMjZuaGpkYTAwMXAzMm5zdGVvZ2c0OHYifQ.s8MMs2wW15ZyUfDhTS_cdQ';

var { MapboxLayer, HexagonLayer, MapboxLayer, ScatterplotLayer, H3HexagonLayer } = deck;

//Create the Mapbox map
var map = new mapboxgl.Map({
    container: 'map',
    style: 'data/osm_liberty.json',
    center: [ 39.1, 48.5],
    zoom: 10,
    pitch: 60,
    antialias: true
});

// Get Data for visual
var DATA_URL = 'https://raw.githubusercontent.com/uber-common/deck.gl-data/master/examples/3d-heatmap/heatmap-data.csv';

//Create the deck.gl hexagon layer and style for the data
var COLOR_RANGE = [
    [1, 152, 189],
    [73, 227, 206],
    [216, 254, 181],
    [254, 237, 177],
    [254, 173, 84],
    [209, 55, 78]
];
var LIGHT_SETTINGS = {
    lightsPosition: [-0.144528, 49.739968, 8000, -3.807751, 54.104682, 8000],
    ambientRatio: 0.4,
    diffuseRatio: 0.6,
    specularRatio: 0.2,
    lightsStrength: [0.8, 0.0, 0.8, 0.0],
    numberOfLights: 2
};

var hexagonLayer;

//Add the deck.gl Custom Layer to the map once the Mapbox map loads
map.on('load', () => {
    const firstLabelLayerId = map.getStyle().layers.find(layer => layer.type === 'symbol').id;


      map.addLayer({
        'id': '3d-buildings',
        'source': 'composite',
        'source-layer': 'building',
        'filter': ['==', 'extrude', 'true'],
        'type': 'fill-extrusion',
        'minzoom': 15,
        'paint': {
            'fill-extrusion-color': '#aaa',

            // use an 'interpolate' expression to add a smooth transition effect to the
            // buildings as the user zooms in
            'fill-extrusion-height': [
                "interpolate", ["linear"], ["zoom"],
                15, 0,
                15.05, ["get", "height"]
            ],
            'fill-extrusion-base': [
                "interpolate", ["linear"], ["zoom"],
                15, 0,
                15.05, ["get", "min_height"]
            ],
            'fill-extrusion-opacity': .6
        }
      }, firstLabelLayerId);

      map.addLayer(new MapboxLayer({
        id: 'deckgl-circle',
        type: ScatterplotLayer,
        data: [
          {position: [-122.402, 37.79], color: [255, 0, 0], radius: 1000}
        ],
        getPosition: d => d.position,
        getFillColor: d => d.color,
        getRadius: d => d.radius,
        opacity: 0.3
      }), firstLabelLayerId);


      map.addLayer(new MapboxLayer({
        id: 'h3',
        type: H3HexagonLayer,
        data: 'https://raw.githubusercontent.com/samoylich/damage_map_data/main/lugansk_9.json', 
           
            elevationScale: 2.5,
            extruded: true,
            filled: true,
            getElevation: d => powScale(d.count),
            getFillColor: d => getRGB(color2(d.count)),
            getHexagon: d => d.hex,
            wireframe: false,
            pickable: true,
            visible: true,
            opacity: 1
      }), firstLabelLayerId);

    });



</script>

</html>